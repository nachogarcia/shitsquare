---
- name: install postgis
  apt:
    pkg: postgis
    state: present

- name: create database
  become: yes
  become_user: postgres
  postgresql_db:
    name: shitsquaredb
    state: present

- name: create database user
  become: yes
  become_user: postgres
  postgresql_user:
    name: shitsquareuser
    password: shitsquarepassword
    role_attr_flags: "SUPERUSER"

- name: add postgis to database
  become: yes
  become_user: postgres
  postgresql_ext:
    name: postgis
    db: shitsquaredb

- name: clone repository
  git:
    repo: 'https://github.com/nachogarcia/shitsquare.git'
    dest: /var/www/shitsquare

- name: install domain packages
  npm:
    path: /var/www/shitsquare/domain

- name: install api packages
  npm:
    path: /var/www/shitsquare/api

- name: initialize database
  shell: node /var/www/shitsquare/domain/DBHandler.js init

- name: create api service
  template:
    src=api-service.j2
    dest=/etc/systemd/system/shitsquare-api.service

- name: start api service
  service:
    name: shitsquare-api
    enabled: yes
    state: started
